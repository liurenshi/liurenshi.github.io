<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  

  
  <title>kata containers configuration解析 | Newcent Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="本文以configuration.toml文档为基础，分析configuration 从configuration.toml到kata配置选项位于runtime/pkg/katautils/config.go 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152">
<meta property="og:type" content="article">
<meta property="og:title" content="kata containers configuration解析">
<meta property="og:url" content="http://yoursite.com/2019/06/19/kata-container-configuration-解析/index.html">
<meta property="og:site_name" content="Newcent Blog">
<meta property="og:description" content="本文以configuration.toml文档为基础，分析configuration 从configuration.toml到kata配置选项位于runtime/pkg/katautils/config.go 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152">
<meta property="og:locale" content="default">
<meta property="og:updated_time" content="2019-06-19T06:13:04.492Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="kata containers configuration解析">
<meta name="twitter:description" content="本文以configuration.toml文档为基础，分析configuration 从configuration.toml到kata配置选项位于runtime/pkg/katautils/config.go 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152">
  
    <link rel="alternate" href="/atom.xml" title="Newcent Blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
</head>
</html>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Newcent Blog</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">大道至简</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-kata-container-configuration-解析" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/06/19/kata-container-configuration-解析/" class="article-date">
  <time datetime="2019-06-19T06:09:32.000Z" itemprop="datePublished">2019-06-19</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      kata containers configuration解析
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>本文以configuration.toml文档为基础，分析configuration</p>
<p>从configuration.toml到kata配置选项位于runtime/pkg/katautils/config.go</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> hypervisor <span class="keyword">struct</span> &#123;</span><br><span class="line">	Path                    <span class="keyword">string</span> <span class="string">`toml:"path"`</span></span><br><span class="line">	Kernel                  <span class="keyword">string</span> <span class="string">`toml:"kernel"`</span></span><br><span class="line">	Initrd                  <span class="keyword">string</span> <span class="string">`toml:"initrd"`</span></span><br><span class="line">	Image                   <span class="keyword">string</span> <span class="string">`toml:"image"`</span></span><br><span class="line">	Firmware                <span class="keyword">string</span> <span class="string">`toml:"firmware"`</span></span><br><span class="line">	MachineAccelerators     <span class="keyword">string</span> <span class="string">`toml:"machine_accelerators"`</span></span><br><span class="line">	KernelParams            <span class="keyword">string</span> <span class="string">`toml:"kernel_params"`</span></span><br><span class="line">	MachineType             <span class="keyword">string</span> <span class="string">`toml:"machine_type"`</span></span><br><span class="line">	BlockDeviceDriver       <span class="keyword">string</span> <span class="string">`toml:"block_device_driver"`</span></span><br><span class="line">	EntropySource           <span class="keyword">string</span> <span class="string">`toml:"entropy_source"`</span></span><br><span class="line">	SharedFS                <span class="keyword">string</span> <span class="string">`toml:"shared_fs"`</span></span><br><span class="line">	VirtioFSDaemon          <span class="keyword">string</span> <span class="string">`toml:"virtio_fs_daemon"`</span></span><br><span class="line">	VirtioFSCache           <span class="keyword">string</span> <span class="string">`toml:"virtio_fs_cache"`</span></span><br><span class="line">	VirtioFSCacheSize       <span class="keyword">uint32</span> <span class="string">`toml:"virtio_fs_cache_size"`</span></span><br><span class="line">	BlockDeviceCacheSet     <span class="keyword">bool</span>   <span class="string">`toml:"block_device_cache_set"`</span></span><br><span class="line">	BlockDeviceCacheDirect  <span class="keyword">bool</span>   <span class="string">`toml:"block_device_cache_direct"`</span></span><br><span class="line">	BlockDeviceCacheNoflush <span class="keyword">bool</span>   <span class="string">`toml:"block_device_cache_noflush"`</span></span><br><span class="line">	NumVCPUs                <span class="keyword">int32</span>  <span class="string">`toml:"default_vcpus"`</span></span><br><span class="line">	DefaultMaxVCPUs         <span class="keyword">uint32</span> <span class="string">`toml:"default_maxvcpus"`</span></span><br><span class="line">	MemorySize              <span class="keyword">uint32</span> <span class="string">`toml:"default_memory"`</span></span><br><span class="line">	MemSlots                <span class="keyword">uint32</span> <span class="string">`toml:"memory_slots"`</span></span><br><span class="line">	MemOffset               <span class="keyword">uint32</span> <span class="string">`toml:"memory_offset"`</span></span><br><span class="line">	DefaultBridges          <span class="keyword">uint32</span> <span class="string">`toml:"default_bridges"`</span></span><br><span class="line">	Msize9p                 <span class="keyword">uint32</span> <span class="string">`toml:"msize_9p"`</span></span><br><span class="line">	DisableBlockDeviceUse   <span class="keyword">bool</span>   <span class="string">`toml:"disable_block_device_use"`</span></span><br><span class="line">	MemPrealloc             <span class="keyword">bool</span>   <span class="string">`toml:"enable_mem_prealloc"`</span></span><br><span class="line">	HugePages               <span class="keyword">bool</span>   <span class="string">`toml:"enable_hugepages"`</span></span><br><span class="line">	FileBackedMemRootDir    <span class="keyword">string</span> <span class="string">`toml:"file_mem_backend"`</span></span><br><span class="line">	Swap                    <span class="keyword">bool</span>   <span class="string">`toml:"enable_swap"`</span></span><br><span class="line">	Debug                   <span class="keyword">bool</span>   <span class="string">`toml:"enable_debug"`</span></span><br><span class="line">	DisableNestingChecks    <span class="keyword">bool</span>   <span class="string">`toml:"disable_nesting_checks"`</span></span><br><span class="line">	EnableIOThreads         <span class="keyword">bool</span>   <span class="string">`toml:"enable_iothreads"`</span></span><br><span class="line">	UseVSock                <span class="keyword">bool</span>   <span class="string">`toml:"use_vsock"`</span></span><br><span class="line">	HotplugVFIOOnRootBus    <span class="keyword">bool</span>   <span class="string">`toml:"hotplug_vfio_on_root_bus"`</span></span><br><span class="line">	DisableVhostNet         <span class="keyword">bool</span>   <span class="string">`toml:"disable_vhost_net"`</span></span><br><span class="line">	GuestHookPath           <span class="keyword">string</span> <span class="string">`toml:"guest_hook_path"`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> proxy <span class="keyword">struct</span> &#123;</span><br><span class="line">	Path  <span class="keyword">string</span> <span class="string">`toml:"path"`</span></span><br><span class="line">	Debug <span class="keyword">bool</span>   <span class="string">`toml:"enable_debug"`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> runtime <span class="keyword">struct</span> &#123;</span><br><span class="line">	Debug               <span class="keyword">bool</span>     <span class="string">`toml:"enable_debug"`</span></span><br><span class="line">	Tracing             <span class="keyword">bool</span>     <span class="string">`toml:"enable_tracing"`</span></span><br><span class="line">	DisableNewNetNs     <span class="keyword">bool</span>     <span class="string">`toml:"disable_new_netns"`</span></span><br><span class="line">	DisableGuestSeccomp <span class="keyword">bool</span>     <span class="string">`toml:"disable_guest_seccomp"`</span></span><br><span class="line">	Experimental        []<span class="keyword">string</span> <span class="string">`toml:"experimental"`</span></span><br><span class="line">	InterNetworkModel   <span class="keyword">string</span>   <span class="string">`toml:"internetworking_model"`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> shim <span class="keyword">struct</span> &#123;</span><br><span class="line">	Path    <span class="keyword">string</span> <span class="string">`toml:"path"`</span></span><br><span class="line">	Debug   <span class="keyword">bool</span>   <span class="string">`toml:"enable_debug"`</span></span><br><span class="line">	Tracing <span class="keyword">bool</span>   <span class="string">`toml:"enable_tracing"`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> agent <span class="keyword">struct</span> &#123;</span><br><span class="line">	Debug     <span class="keyword">bool</span>   <span class="string">`toml:"enable_debug"`</span></span><br><span class="line">	Tracing   <span class="keyword">bool</span>   <span class="string">`toml:"enable_tracing"`</span></span><br><span class="line">	TraceMode <span class="keyword">string</span> <span class="string">`toml:"trace_mode"`</span></span><br><span class="line">	TraceType <span class="keyword">string</span> <span class="string">`toml:"trace_type"`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> netmon <span class="keyword">struct</span> &#123;</span><br><span class="line">	Path   <span class="keyword">string</span> <span class="string">`toml:"path"`</span></span><br><span class="line">	Debug  <span class="keyword">bool</span>   <span class="string">`toml:"enable_debug"`</span></span><br><span class="line">	Enable <span class="keyword">bool</span>   <span class="string">`toml:"enable_netmon"`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="1-hypervisor-qemu"><a href="#1-hypervisor-qemu" class="headerlink" title="1. [hypervisor.qemu]"></a>1. [hypervisor.qemu]</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">path = &quot;/usr/bin/qemu-system-x86_64&quot;</span><br></pre></td></tr></table></figure>

<p>指定qemu的路径</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kernel = &quot;/usr/share/kata-containers/vmlinuz.container&quot;</span><br></pre></td></tr></table></figure>

<p>指定启动内核路径，启动内核可以根据需要自己定制，定制文档见<a href>https://github.com/kata-containers/documentation/blob/master/Developer-Guide.md#install-guest-kernel-images</a>,其实就是配置-kernel ${kernel_path}</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">initrd = &quot;/usr/share/kata-containers/kata-containers-initrd.img&quot;</span><br></pre></td></tr></table></figure>

<p>指定initrd</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">image = &quot;/usr/share/kata-containers/kata-containers-centos.img&quot;</span><br></pre></td></tr></table></figure>

<p>指定系统盘，initrd和image不可以同时配置，否则会出错</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kernel_params = &quot;&quot;</span><br></pre></td></tr></table></figure>

<p>配置-append参数，定制虚拟机内核启动参数，这部分的修改要慎重，很可能导致guest kernel无法启动成功,具体处理函数在/runtime/virtcontainers/qemu.go的KernelParameters()中处理，vendor/github.com/intel/govmmm/qemu/qemu.go中以-apped为前缀将参数赋给启动选项。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">firmware = &quot;&quot;</span><br></pre></td></tr></table></figure>

<p>指定固件，影响qemu的-bios参数，不过从qemu代码看貌似只对ARM平台生效</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">machine_accelerators=&quot;&quot;</span><br></pre></td></tr></table></figure>

<p>virtcontainers/qemu.go的getQemuMachine()进行处理，加到machine.Options中，最终是加到-machine参数中。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">default_vcpus = 1</span><br></pre></td></tr></table></figure>

<p>默认vcpu个数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">default_maxvcpus = 0</span><br></pre></td></tr></table></figure>

<p>默认最大vcpu个数，设置为0时实际上时240,具体见qemu_amd64.go中MaxQemuVCPUs()</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">default_bridges = 1</span><br></pre></td></tr></table></figure>

<p>默认PCI桥个数，kata-runtime在启动qemu虚拟机时会根据bridge个数创建bridge桥，具体见qemu_arc_base.go中<br>func (q *qemuArchBase) bridges(number uint32) []types.PCIBridge</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(q *qemuArchBase)</span> <span class="title">bridges</span><span class="params">(number <span class="keyword">uint32</span>)</span> []<span class="title">types</span>.<span class="title">PCIBridge</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> bridges []types.PCIBridge</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> i := <span class="keyword">uint32</span>(<span class="number">0</span>); i &lt; number; i++ &#123;</span><br><span class="line">		bridges = <span class="built_in">append</span>(bridges, types.PCIBridge&#123;</span><br><span class="line">			Type:    types.PCI,</span><br><span class="line">			ID:      fmt.Sprintf(<span class="string">"%s-bridge-%d"</span>, types.PCI, i),</span><br><span class="line">			Address: <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">uint32</span>]<span class="keyword">string</span>),</span><br><span class="line">		&#125;)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> bridges</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">default_memory = 2048</span><br></pre></td></tr></table></figure>

<p>VM默认内存大小</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#memory_slots = 10</span><br></pre></td></tr></table></figure>

<p>内存插槽个数，最终对虚拟机的影响位于qemu如下代码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> main</span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    set_memory_options(&amp;ram_slots, &amp;maxram_size, machine_class);</span><br><span class="line">    ...</span><br><span class="line">    </span><br><span class="line">    current_machine-&gt;ram_size = ram_size;</span><br><span class="line">    current_machine-&gt;maxram_size = maxram_size;</span><br><span class="line">    current_machine-&gt;ram_slots = ram_slots;</span><br><span class="line">    current_machine-&gt;boot_order = boot_order;</span><br><span class="line">    current_machine-&gt;cpu_model = cpu_model;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当热插入内存时，需要找空闲memory slot，因此，该值最终影响kata vm的内存热插拔</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">oid <span class="title">pc_dimm_memory_plug</span><span class="params">(DeviceState *dev, MemoryHotplugState *hpms,</span></span></span><br><span class="line"><span class="function"><span class="params">                         MemoryRegion *mr, <span class="keyword">uint64_t</span> align, Error **errp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ......</span><br><span class="line">    slot = pc_dimm_get_free_slot(slot == PC_DIMM_UNASSIGNED_SLOT ? <span class="literal">NULL</span> : &amp;slot,</span><br><span class="line">                                 machine-&gt;ram_slots, &amp;local_err);</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">disable_block_device_use = false</span><br></pre></td></tr></table></figure>

<p>是否禁用块设备,从当前代码看，该参数主要影响检测容器是否支持块设备</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Container)</span> <span class="title">checkBlockDeviceSupport</span><span class="params">()</span> <span class="title">bool</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> !c.sandbox.config.HypervisorConfig.DisableBlockDeviceUse &#123;</span><br><span class="line">		agentCaps := c.sandbox.agent.capabilities()</span><br><span class="line">		hypervisorCaps := c.sandbox.hypervisor.capabilities()</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> agentCaps.IsBlockDeviceSupported() &amp;&amp; hypervisorCaps.IsBlockDeviceHotplugSupported() &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>由于对于qemu是设置为支持块设备热插拔的，因此可以认为容器checkBlockDeviceSupport仅跟disalbe_block_device相关。若支持块设备，在容器启动时会调用c.hotplugDrive()<strong>(具体机制待完善</strong>),对容器创建和热插入块设备时也能得到支持。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">block_device_driver = &quot;virtio-scsi&quot;</span><br></pre></td></tr></table></figure>

<p>块设备驱动，可以是virtio-scsi、virtio-blk或nvdimm，主要影响虚拟机创建时或者热插入块设备参数</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(q *qemu)</span> <span class="title">hotplugAddBlockDevice</span><span class="params">(drive *config.BlockDrive, op operation, devID <span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">    ......</span><br><span class="line">	<span class="keyword">if</span> q.config.BlockDeviceDriver == config.VirtioBlock &#123;</span><br><span class="line">		driver := <span class="string">"virtio-blk-pci"</span></span><br><span class="line">		......</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		driver := <span class="string">"scsi-hd"</span></span><br><span class="line">        ......</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#block_device_cache_set = true</span><br><span class="line">#block_device_cache_direct = true</span><br><span class="line">#block_device_cache_noflush = true</span><br></pre></td></tr></table></figure>

<p>块设备是否设置cache，具体使用如下:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(q *qemu)</span> <span class="title">hotplugAddBlockDevice</span><span class="params">(drive *config.BlockDrive, op operation, devID <span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">    ......</span><br><span class="line">	<span class="keyword">if</span> q.config.BlockDeviceCacheSet &#123;</span><br><span class="line">		err = q.qmpMonitorCh.qmp.ExecuteBlockdevAddWithCache(q.qmpMonitorCh.ctx, drive.File, drive.ID, q.config.BlockDeviceCacheDirect, q.config.BlockDeviceCacheNoflush)</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		err = q.qmpMonitorCh.qmp.ExecuteBlockdevAdd(q.qmpMonitorCh.ctx, drive.File, drive.ID)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="string">'''</span><span class="string">'''</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">enable_iothreads = false</span><br></pre></td></tr></table></figure>

<p>enable_iothreas当前仅针对virtio-scsi块设备生效</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(q *qemu)</span> <span class="title">buildDevices</span><span class="params">(initrdPath <span class="keyword">string</span>)</span> <span class="params">([]govmmQemu.Device, *govmmQemu.IOThread, error)</span></span> &#123;</span><br><span class="line">    ......</span><br><span class="line">	<span class="keyword">var</span> ioThread *govmmQemu.IOThread</span><br><span class="line">	<span class="keyword">if</span> q.config.BlockDeviceDriver == config.VirtioSCSI &#123;</span><br><span class="line">		devices, ioThread = q.arch.appendSCSIController(devices, q.config.EnableIOThreads)</span><br><span class="line">    &#125;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#enable_mem_prealloc = true</span><br><span class="line">#enable_hugepages = true</span><br><span class="line">#file_mem_backend = &quot;&quot;</span><br></pre></td></tr></table></figure>

<p>这几个配置统一用于kata-runtime qemu插件启动虚拟机时的内存配置，有限级分别是enable_mem_prealloc &gt; enable_hugepages &gt; file_mem_backend，具体见下述代码(<strong>1.5版本的kata无file_mem_backend配置</strong>)</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(config *Config)</span> <span class="title">appendMemoryKnobs</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> config.Knobs.HugePages &#123;</span><br><span class="line">		<span class="keyword">if</span> config.Memory.Size != <span class="string">""</span> &#123;</span><br><span class="line">			dimmName := <span class="string">"dimm1"</span></span><br><span class="line">			objMemParam := <span class="string">"memory-backend-file,id="</span> + dimmName + <span class="string">",size="</span> + config.Memory.Size + <span class="string">",mem-path=/dev/hugepages,share=on,prealloc=on"</span></span><br><span class="line">			numaMemParam := <span class="string">"node,memdev="</span> + dimmName</span><br><span class="line"></span><br><span class="line">			config.qemuParams = <span class="built_in">append</span>(config.qemuParams, <span class="string">"-object"</span>)</span><br><span class="line">			config.qemuParams = <span class="built_in">append</span>(config.qemuParams, objMemParam)</span><br><span class="line"></span><br><span class="line">			config.qemuParams = <span class="built_in">append</span>(config.qemuParams, <span class="string">"-numa"</span>)</span><br><span class="line">			config.qemuParams = <span class="built_in">append</span>(config.qemuParams, numaMemParam)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> config.Knobs.MemPrealloc &#123;</span><br><span class="line">		<span class="keyword">if</span> config.Memory.Size != <span class="string">""</span> &#123;</span><br><span class="line">			dimmName := <span class="string">"dimm1"</span></span><br><span class="line">			objMemParam := <span class="string">"memory-backend-ram,id="</span> + dimmName + <span class="string">",size="</span> + config.Memory.Size + <span class="string">",prealloc=on"</span></span><br><span class="line">			numaMemParam := <span class="string">"node,memdev="</span> + dimmName</span><br><span class="line"></span><br><span class="line">			config.qemuParams = <span class="built_in">append</span>(config.qemuParams, <span class="string">"-object"</span>)</span><br><span class="line">			config.qemuParams = <span class="built_in">append</span>(config.qemuParams, objMemParam)</span><br><span class="line"></span><br><span class="line">			config.qemuParams = <span class="built_in">append</span>(config.qemuParams, <span class="string">"-numa"</span>)</span><br><span class="line">			config.qemuParams = <span class="built_in">append</span>(config.qemuParams, numaMemParam)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> config.Knobs.FileBackedMem &#123;</span><br><span class="line">		<span class="keyword">if</span> config.Memory.Size != <span class="string">""</span> &amp;&amp; config.Memory.Path != <span class="string">""</span> &#123;</span><br><span class="line">			dimmName := <span class="string">"dimm1"</span></span><br><span class="line">			objMemParam := <span class="string">"memory-backend-file,id="</span> + dimmName + <span class="string">",size="</span> + config.Memory.Size + <span class="string">",mem-path="</span> + config.Memory.Path</span><br><span class="line">			<span class="keyword">if</span> config.Knobs.FileBackedMemShared &#123;</span><br><span class="line">				objMemParam += <span class="string">",share=on"</span></span><br><span class="line">			&#125;</span><br><span class="line">			numaMemParam := <span class="string">"node,memdev="</span> + dimmName</span><br><span class="line"></span><br><span class="line">			config.qemuParams = <span class="built_in">append</span>(config.qemuParams, <span class="string">"-object"</span>)</span><br><span class="line">			config.qemuParams = <span class="built_in">append</span>(config.qemuParams, objMemParam)</span><br><span class="line"></span><br><span class="line">			config.qemuParams = <span class="built_in">append</span>(config.qemuParams, <span class="string">"-numa"</span>)</span><br><span class="line">			config.qemuParams = <span class="built_in">append</span>(config.qemuParams, numaMemParam)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#enable_swap=true</span><br></pre></td></tr></table></figure>

<p>是否允许虚拟机内存swap，以支持更大的虚拟机密度。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#enable_debug=false</span><br></pre></td></tr></table></figure>

<p>从代码看，是影响guest kernel内核启动，在enable_debug后，guest kernel启动项会加上</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemd.show_status true systemd.log_level debug</span><br></pre></td></tr></table></figure>

<p>具体代码位于</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">newQemuArch</span><span class="params">(config HypervisorConfig)</span> <span class="title">qemuArch</span></span> &#123;</span><br><span class="line">    ......</span><br><span class="line">	<span class="keyword">if</span> config.ImagePath != <span class="string">""</span> &#123;</span><br><span class="line">		q.kernelParams = <span class="built_in">append</span>(q.kernelParams, kernelRootParams...)</span><br><span class="line">		q.kernelParamsNonDebug = <span class="built_in">append</span>(q.kernelParamsNonDebug, kernelParamsSystemdNonDebug...)</span><br><span class="line">		q.kernelParamsDebug = <span class="built_in">append</span>(q.kernelParamsDebug, kernelParamsSystemdDebug...)</span><br><span class="line">    &#125;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SetKernelParams adds the user-specified kernel parameters (from the</span></span><br><span class="line"><span class="comment">// configuration file) to the defaults so that the former take priority.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">SetKernelParams</span><span class="params">(runtimeConfig *oci.RuntimeConfig)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	......</span><br><span class="line">	<span class="keyword">if</span> runtimeConfig.HypervisorConfig.Debug &#123;</span><br><span class="line">		strParams := vc.SerializeParams(defaultKernelParams, <span class="string">"="</span>)</span><br><span class="line">		formatted := strings.Join(strParams, <span class="string">" "</span>)</span><br><span class="line"></span><br><span class="line">		kataUtilsLogger.WithField(<span class="string">"default-kernel-parameters"</span>, formatted).Debug()</span><br><span class="line">	&#125;</span><br><span class="line">	......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#disable_nesting_checks = true</span><br></pre></td></tr></table></figure>

<p>这个配置项主要影响虚拟机标志是否nestedRun，即虚拟化嵌套</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// setup sets the Qemu structure up.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(q *qemu)</span> <span class="title">setup</span><span class="params">(id <span class="keyword">string</span>, hypervisorConfig *HypervisorConfig, vcStore *store.VCStore)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	......</span><br><span class="line">	<span class="keyword">if</span> !q.config.DisableNestingChecks &amp;&amp; nested &#123;</span><br><span class="line">		q.arch.enableNestingChecks()</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		q.Logger().WithField(<span class="string">"inside-vm"</span>, fmt.Sprintf(<span class="string">"%t"</span>, nested)).Debug(<span class="string">"Disable nesting environment checks"</span>)</span><br><span class="line">		q.arch.disableNestingChecks()</span><br><span class="line">	&#125;</span><br><span class="line">	......</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(q *qemuArchBase)</span> <span class="title">enableNestingChecks</span><span class="params">()</span></span> &#123;</span><br><span class="line">	q.nestedRun = <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(q *qemuAmd64)</span> <span class="title">cpuModel</span><span class="params">()</span> <span class="title">string</span></span> &#123;</span><br><span class="line">	cpuModel := defaultCPUModel</span><br><span class="line">	<span class="keyword">if</span> q.nestedRun &#123;</span><br><span class="line">		cpuModel += <span class="string">",pmu=off"</span>	</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// VMX is not migratable yet.</span></span><br><span class="line">	<span class="comment">// issue: https://github.com/kata-containers/runtime/issues/1750</span></span><br><span class="line">	<span class="keyword">if</span> q.vmFactory &#123;</span><br><span class="line">		virtLog.WithField(<span class="string">"subsystem"</span>, <span class="string">"qemuAmd64"</span>).Warn(<span class="string">"VMX is not migratable yet: turning it off"</span>)</span><br><span class="line">		cpuModel += <span class="string">",vmx=off"</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> cpuModel</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msize=8192</span><br></pre></td></tr></table></figure>

<p>影响9p fs msize选项</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(k *kataAgent)</span> <span class="title">startSandbox</span><span class="params">(sandbox *Sandbox)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	......</span><br><span class="line">	<span class="comment">// append 9p shared volume to storages only if filesystem sharing is supported</span></span><br><span class="line">	<span class="keyword">if</span> caps.IsFsSharingSupported() &#123;</span><br><span class="line">		<span class="comment">// We mount the shared directory in a predefined location</span></span><br><span class="line">		<span class="comment">// in the guest.</span></span><br><span class="line">		<span class="comment">// This is where at least some of the host config files</span></span><br><span class="line">		<span class="comment">// (resolv.conf, etc...) and potentially all container</span></span><br><span class="line">		<span class="comment">// rootfs will reside.</span></span><br><span class="line">		<span class="keyword">if</span> sandbox.config.HypervisorConfig.SharedFS == config.VirtioFS &#123;</span><br><span class="line">			sharedVolume := &amp;grpc.Storage&#123;</span><br><span class="line">				Driver:     kataVirtioFSDevType,</span><br><span class="line">				Source:     <span class="string">"none"</span>,</span><br><span class="line">				MountPoint: kataGuestSharedDir,</span><br><span class="line">				Fstype:     typeVirtioFS,</span><br><span class="line">				Options:    sharedDirVirtioFSOptions,</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			storages = <span class="built_in">append</span>(storages, sharedVolume)</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			sharedDir9pOptions = <span class="built_in">append</span>(sharedDir9pOptions, fmt.Sprintf(<span class="string">"msize=%d"</span>, sandbox.config.HypervisorConfig.Msize9p))</span><br><span class="line"></span><br><span class="line">			sharedVolume := &amp;grpc.Storage&#123;</span><br><span class="line">				Driver:     kata9pDevType,</span><br><span class="line">				Source:     mountGuest9pTag,</span><br><span class="line">				MountPoint: kataGuestSharedDir,</span><br><span class="line">				Fstype:     type9pFs,</span><br><span class="line">				Options:    sharedDir9pOptions,</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			storages = <span class="built_in">append</span>(storages, sharedVolume)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#use_vsock = true</span><br></pre></td></tr></table></figure>

<p>是否使用vsock,使用vsock时，可以直接同kata-agent通信，kata-proxy无须启动，不过vsock对guest kernel有要求</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">LoadConfiguration</span><span class="params">(configPath <span class="keyword">string</span>, ignoreLogging, builtIn <span class="keyword">bool</span>)</span> <span class="params">(resolvedConfigPath <span class="keyword">string</span>, config oci.RuntimeConfig, err error)</span></span> &#123;</span><br><span class="line">	......</span><br><span class="line">	<span class="comment">// use no proxy if HypervisorConfig.UseVSock is true</span></span><br><span class="line">	<span class="keyword">if</span> config.HypervisorConfig.UseVSock &#123;</span><br><span class="line">		kataUtilsLogger.Info(<span class="string">"VSOCK supported, configure to not use proxy"</span>)</span><br><span class="line">		config.ProxyType = vc.NoProxyType</span><br><span class="line">		config.ProxyConfig = vc.ProxyConfig&#123;&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(q *qemu)</span> <span class="title">kernelParameters</span><span class="params">()</span> <span class="title">string</span></span> &#123;</span><br><span class="line">	......</span><br><span class="line">	params = <span class="built_in">append</span>(params, Param&#123;vsockKernelOption, strconv.FormatBool(q.config.UseVSock)&#125;)</span><br><span class="line">	......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#hotplug_vfio_on_root_bus = true</span><br></pre></td></tr></table></figure>

<p>默认是false，若支持hotplug_vfio_on_root_bus，对于vfio设备，会挂在到root bus上，否则挂载到PCI bridge上,</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(q *qemu)</span> <span class="title">hotplugVFIODevice</span><span class="params">(device *config.VFIODev, op operation)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	......</span><br><span class="line">	<span class="keyword">if</span> op == addDevice &#123;</span><br><span class="line">		<span class="comment">// In case HotplugVFIOOnRootBus is true, devices are hotplugged on the root bus</span></span><br><span class="line">		<span class="comment">// for pc machine type instead of bridge. This is useful for devices that require</span></span><br><span class="line">		<span class="comment">// a large PCI BAR which is a currently a limitation with PCI bridges.</span></span><br><span class="line">		<span class="keyword">if</span> q.state.HotplugVFIOOnRootBus &#123;</span><br><span class="line">			<span class="keyword">switch</span> device.Type &#123;</span><br><span class="line">			<span class="keyword">case</span> config.VFIODeviceNormalType:</span><br><span class="line">				<span class="keyword">return</span> q.qmpMonitorCh.qmp.ExecuteVFIODeviceAdd(q.qmpMonitorCh.ctx, devID, device.BDF, romFile)</span><br><span class="line">			<span class="keyword">case</span> config.VFIODeviceMediatedType:</span><br><span class="line">				<span class="keyword">return</span> q.qmpMonitorCh.qmp.ExecutePCIVFIOMediatedDeviceAdd(q.qmpMonitorCh.ctx, devID, device.SysfsDev, <span class="string">""</span>, <span class="string">""</span>, romFile)</span><br><span class="line">			<span class="keyword">default</span>:</span><br><span class="line">				<span class="keyword">return</span> fmt.Errorf(<span class="string">"Incorrect VFIO device type found"</span>)</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		addr, bridge, err := q.addDeviceToBridge(devID)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">switch</span> device.Type &#123;</span><br><span class="line">		<span class="keyword">case</span> config.VFIODeviceNormalType:</span><br><span class="line">			<span class="keyword">return</span> q.qmpMonitorCh.qmp.ExecutePCIVFIODeviceAdd(q.qmpMonitorCh.ctx, devID, device.BDF, addr, bridge.ID, romFile)</span><br><span class="line">		<span class="keyword">case</span> config.VFIODeviceMediatedType:</span><br><span class="line">			<span class="keyword">return</span> q.qmpMonitorCh.qmp.ExecutePCIVFIOMediatedDeviceAdd(q.qmpMonitorCh.ctx, devID, device.SysfsDev, addr, bridge.ID, romFile)</span><br><span class="line">		<span class="keyword">default</span>:</span><br><span class="line">			<span class="keyword">return</span> fmt.Errorf(<span class="string">"Incorrect VFIO device type found"</span>)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#disable_vhost_net = true</span><br></pre></td></tr></table></figure>

<p>禁用vhost_net，默认为false，禁用vhost_net后，对于虚拟机的nics，不创建vhost fds</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Attach for macvtap endpoint passes macvtap device to the hypervisor.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(endpoint *MacvtapEndpoint)</span> <span class="title">Attach</span><span class="params">(h hypervisor)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	......</span><br><span class="line">	<span class="keyword">if</span> !h.hypervisorConfig().DisableVhostNet &#123;</span><br><span class="line">		vhostFds, err := createVhostFds(<span class="keyword">int</span>(h.hypervisorConfig().NumVCPUs))</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> fmt.Errorf(<span class="string">"Could not setup vhost fds %s : %s"</span>, endpoint.EndpointProperties.Iface.Name, err)</span><br><span class="line">		&#125;</span><br><span class="line">		endpoint.VhostFds = vhostFds</span><br><span class="line">	&#125;</span><br><span class="line">	......</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(q *qemuArchBase)</span> <span class="title">appendNetwork</span><span class="params">(devices []govmmQemu.Device, endpoint Endpoint)</span> []<span class="title">govmmQemu</span>.<span class="title">Device</span></span> &#123;</span><br><span class="line">	<span class="keyword">switch</span> ep := endpoint.(<span class="keyword">type</span>) &#123;</span><br><span class="line">	<span class="keyword">case</span> *VethEndpoint, *BridgedMacvlanEndpoint, *IPVlanEndpoint:</span><br><span class="line">		netPair := ep.NetworkPair()</span><br><span class="line">		devices = <span class="built_in">append</span>(devices,</span><br><span class="line">			govmmQemu.NetDevice&#123;</span><br><span class="line">				......</span><br><span class="line">				VHost:         q.vhost,</span><br><span class="line">				......</span><br><span class="line">			&#125;,</span><br><span class="line">		)</span><br><span class="line">		......</span><br><span class="line">	......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#entropy_source= &quot;/dev/urandom&quot;</span><br></pre></td></tr></table></figure>

<p>指定随机数发生器，默认为/dev/urandom,kata启动虚拟机时会给虚拟机附加一个随机数发生器</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// createSandbox is the Hypervisor sandbox creation implementation for govmmQemu.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(q *qemu)</span> <span class="title">createSandbox</span><span class="params">(ctx context.Context, id <span class="keyword">string</span>, hypervisorConfig *HypervisorConfig, store *store.VCStore)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	......</span><br><span class="line">	qemuConfig.Devices = q.arch.appendRNGDevice(qemuConfig.Devices, rngDev)</span><br><span class="line">	......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#guest_hook_path = &quot;/usr/share/oci/hooks&quot;</span><br></pre></td></tr></table></figure>

<p>guest钩子函数执行路径,用于OCI，只影响guest，不影响host，kata-agent在启动时会从这一路径下查找相关的钩子程序执行，比如说prestart,postart,poststop,出错也只会告警，不影响启动</p>
<p>##[factory]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#enable_template = true</span><br></pre></td></tr></table></figure>

<p>默认为false，enable后新的虚拟机从模板通过虚拟机克隆方式启动，所有VM共享相同的初始化kernel、initramfs和agent内存。</p>
<p>##[proxy.kata]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">path = &quot;/usr/libexec/kata-containers/kata-proxy&quot;</span><br></pre></td></tr></table></figure>

<p>kata proxy路径</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#enable_debug=true</span><br></pre></td></tr></table></figure>

<p>kata proxy是否enable debug，enable debug后，proxy 消息发往system log，默认为false</p>
<p>##[shim.kata]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">path = &quot;/usr/libexec/kata-containers/kata-shim&quot;</span><br></pre></td></tr></table></figure>

<p>kata shim的路径</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#enable_debug = true</span><br></pre></td></tr></table></figure>

<p>默认为false，enable后，shim将消息发往system log</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#enable_tracing = true</span><br></pre></td></tr></table></figure>

<p>默认为false，用于跟踪</p>
<p>##[agent.kata]</p>
<p>##[netmon]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">enable_netmon=true</span><br></pre></td></tr></table></figure>

<p>默认为false，enable后可以探测到sandbox创建后，已经存在的网络namespace中有额外的网络加入。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">path = &quot;/usr/libexec/kata-containers/kata-netmon&quot;</span><br></pre></td></tr></table></figure>

<p>netmon的路径</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#enable_debug = true</span><br></pre></td></tr></table></figure>

<p>默认为false，enable后，netmon消息会发往system log</p>
<p>##[runtime]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#enable_debug = true</span><br></pre></td></tr></table></figure>

<p>默认为false，enable后，会将消息发往system log</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">internetworking_model=&quot;macvtap&quot;</span><br></pre></td></tr></table></figure>

<p>虚拟机以何种方式连接容器网络接口，支持bridged(除了macvlan和ipvlan外都支持)，macvtap，none(使用自定义网络，只创建一个tap设备，不创建veth pair),tcfilter(通过tc filter规则将插件提供的网络接口流量重定向到连接到VM的tap接口)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#enable_tracing = true</span><br></pre></td></tr></table></figure>

<p>默认为false</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#diable_new_netns=true</span><br></pre></td></tr></table></figure>

<p>默认为false，enable后，runtime不会再为shim和hypervisor进程创建一个网络namespace，在enable_netmon、网络模式采用bridged或者macvtap后不能enable该选项</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/06/19/kata-container-configuration-解析/" data-id="cjx2u6wg60002qwpv6khy0ork" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
  
    <a href="/2019/06/14/hello-world/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Hello World</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">June 2019</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2019/06/19/kata-container-configuration-解析/">kata containers configuration解析</a>
          </li>
        
          <li>
            <a href="/2019/06/14/hello-world/">Hello World</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2019 liurenshi<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>



  </div>
</body>
</html>